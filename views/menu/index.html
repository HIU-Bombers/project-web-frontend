<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>食事管理画面</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- ヘッダー -->
  <header class="bg-blue-600 text-white p-4 text-xl font-bold">
    食事管理画面
  </header>

  <!-- メインコンテンツ -->
  <main class="flex-grow container mx-auto p-4 overflow-auto relative">
    <!-- 食事一覧テーブル -->
    <table class="min-w-full bg-white rounded shadow">
      <thead class="bg-gray-200 text-gray-700">
        <tr>
          <th class="py-2 px-3 text-left">名前</th>
          <th class="py-2 px-3 text-left">説明</th>
          <th class="py-2 px-3 text-left">種類</th>
          <th class="py-2 px-3 text-left">画像</th>
          <th class="py-2 px-3 text-left">操作</th>
        </tr>
      </thead>
      <tbody id="mealsBody"></tbody>
    </table>

    <!-- 新規登録用のプラスボタン (モーダルを開く) -->
    <button
      id="showModalBtn"
      class="flex items-center justify-center w-12 h-12 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700
             absolute bottom-4 right-4"
      title="新しい食事を追加"
    >
      <!-- プラスアイコン -->
      <svg xmlns="http://www.w3.org/2000/svg" fill="none"
           viewBox="0 0 24 24" stroke="currentColor"
           class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 4v16m8-8H4" />
      </svg>
    </button>
  </main>

  <!-- フッター -->
  <footer class="bg-gray-200 p-4 text-center">
    フッター
  </footer>

  <!-- ==== モーダル: 新規食事登録 ==== -->
  <div
    id="mealModal"
    class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50"
  >
    <div class="bg-white w-11/12 max-w-md rounded p-6 shadow-md relative">
      <h2 class="text-xl font-bold mb-4 text-center">新しい食事を追加</h2>

      <!-- 閉じるボタン -->
      <button
        type="button"
        class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"
        onclick="closeModal()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" 
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" 
                stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- 登録フォーム -->
      <form id="meal-form" class="space-y-4 mt-4">
        <!-- 名前 -->
        <div>
          <label class="block mb-1 font-semibold">名前</label>
          <input
            type="text"
            id="name"
            class="block w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
            placeholder="カレー"
            required
          />
        </div>

        <!-- 説明 -->
        <div>
          <label class="block mb-1 font-semibold">説明</label>
          <textarea
            id="description"
            class="block w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
            placeholder="メニューの詳細などを入力"
            rows="3"
          ></textarea>
        </div>

        <!-- 種類 -->
        <div>
          <label class="block mb-1 font-semibold">種類</label>
          <select
            id="kind"
            class="block w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
            required
          >
            <option value="" disabled selected>選択してください</option>
            <option value="SET">日替わり (SET)</option>
            <option value="CURRY">カレーライス (CURRY)</option>
            <option value="RAMEN">ラーメン (RAMEN)</option>
            <option value="UDON">うどん (UDON)</option>
            <option value="SOBA">そば (SOBA)</option>
            <option value="OTHER">その他 (OTHER)</option>
          </select>
        </div>

        <!-- 画像アップロード -->
        <div>
          <label class="block mb-1 font-semibold">画像 (アップロード/カメラ)</label>
          <input
            type="file"
            id="meal_image_file"
            class="block w-full p-1 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
            accept="image/*"
            capture="environment"
          />
        </div>

        <!-- プレビュー -->
        <img
          id="preview"
          class="hidden w-full mb-4 rounded shadow-md"
          alt="プレビュー"
        />

        <!-- 登録ボタン -->
        <button
          type="submit"
          class="w-full py-2 bg-blue-600 text-white font-semibold rounded shadow hover:bg-blue-700"
        >
          登録
        </button>
      </form>
    </div>
  </div>

  <!-- ==== モーダル: 画像プレビュー & アップロード ==== -->
  <div
    id="imageModal"
    class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50"
  >
    <div class="bg-white w-11/12 max-w-md rounded p-6 shadow-md relative flex flex-col">
      <!-- 閉じるボタン -->
      <button
        type="button"
        class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"
        onclick="closeImageModal()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" 
             viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round" stroke-linejoin="round" 
            stroke-width="2" d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>

      <!-- 大きめプレビュー or 画像なし表示 -->
      <img
        id="bigPreview"
        src=""
        alt="プレビュー"
        class="mx-auto mb-4 max-h-80 object-contain rounded shadow"
      />

      <p
        id="noImageText"
        class="mx-auto mb-4 text-gray-500 hidden"
      >
        画像が登録されていません
      </p>

      <!-- 新しい画像のアップロード -->
      <form id="replace-form" class="mt-auto">
        <label class="block mb-1 font-semibold">画像を差し替える</label>
        <input
          type="file"
          id="replaceImageFile"
          class="block w-full p-1 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
          accept="image/*"
          capture="environment"
        />
        <button
          type="submit"
          class="w-full mt-2 py-2 bg-blue-600 text-white font-semibold rounded shadow hover:bg-blue-700"
        >
          更新
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    // -------------------------------------------------------
    // 一覧を取得＆テーブル描画
    // -------------------------------------------------------
    window.addEventListener('DOMContentLoaded', () => {
      fetchMealsList();
    });

    async function fetchMealsList() {
      try {
        const res = await fetch('http://localhost:3000/meals');
        if (!res.ok) {
          throw new Error(`Fetch meals error: ${res.status}`);
        }
        const meals = await res.json(); // [ {id, name, description, kind, meal_image}, ...]
        renderMealsTable(meals);
      } catch (err) {
        console.error('一覧取得失敗:', err);
        alert('食事一覧の取得に失敗しました');
      }
    }

    function renderMealsTable(meals) {
      const tbody = document.getElementById('mealsBody');
      tbody.innerHTML = '';

      meals.forEach((meal) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.dataset.mealId = meal.id;

        // 名前
        const tdName = document.createElement('td');
        tdName.className = 'py-2 px-3 text-sm';
        tdName.contentEditable = true;
        tdName.textContent = meal.name ?? '(未設定)';
        tr.appendChild(tdName);

        // 説明
        const tdDesc = document.createElement('td');
        tdDesc.className = 'py-2 px-3 text-sm';
        tdDesc.contentEditable = true;
        tdDesc.textContent = meal.description ?? '';
        tr.appendChild(tdDesc);

        // 種類
        const tdKind = document.createElement('td');
        tdKind.className = 'py-2 px-3 text-sm';
        tdKind.contentEditable = true;
        tdKind.textContent = meal.kind ?? 'OTHER';
        tr.appendChild(tdKind);

        // 画像セル：ボタンかテキストを表示し、クリックするとモーダル
        const tdImage = document.createElement('td');
        tdImage.className = 'py-2 px-3 text-sm';

        const viewImgBtn = document.createElement('button');
        viewImgBtn.textContent = '画像を見る';
        viewImgBtn.className = 'px-2 py-1 text-blue-500 underline text-xs';
        viewImgBtn.onclick = () => {
          openImageModal(meal.id, meal.meal_image);
        };
        tdImage.appendChild(viewImgBtn);

        tr.appendChild(tdImage);

        // 操作 (更新, 削除)
        const tdActions = document.createElement('td');
        tdActions.className = 'py-2 px-3 text-sm';

        const btnUpdate = document.createElement('button');
        btnUpdate.textContent = '更新';
        btnUpdate.className = 'mr-2 px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600';
        btnUpdate.onclick = () => handleMealUpdate(tr, tdName, tdDesc, tdKind);
        tdActions.appendChild(btnUpdate);

        const btnDelete = document.createElement('button');
        btnDelete.textContent = '削除';
        btnDelete.className = 'px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600';
        btnDelete.onclick = () => handleMealDelete(tr);
        tdActions.appendChild(btnDelete);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    // -------------------------------------------------------
    // 更新 (PATCH /meals/:id)
    // -------------------------------------------------------
    async function handleMealUpdate(tr, tdName, tdDesc, tdKind) {
      const mealId = tr.dataset.mealId;
      const newName = tdName.textContent.trim();
      const newDesc = tdDesc.textContent.trim();
      const newKind = tdKind.textContent.trim();

      const payload = {
        name: newName,
        description: newDesc,
        kind: newKind
      };

      const url = `http://localhost:3000/meals/${mealId}`;
      try {
        const res = await fetch(url, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (res.status === 200) {
          alert('更新が完了しました');
        } else {
          const errData = await res.json().catch(() => ({}));
          console.error('更新エラー:', errData);
          alert(`更新失敗 (status: ${res.status})`);
        }
      } catch (err) {
        console.error('通信エラー:', err);
        alert('通信に失敗しました');
      }
    }

    // -------------------------------------------------------
    // 削除 (DELETE /meals/:id)
    // -------------------------------------------------------
    async function handleMealDelete(tr) {
      if (!confirm('本当に削除しますか？')) return;
      const mealId = tr.dataset.mealId;

      try {
        const res = await fetch(`http://localhost:3000/meals/${mealId}`, {
          method: 'DELETE'
        });
        if (res.status === 204) {
          alert('削除が完了しました');
          tr.remove();
        } else {
          const errData = await res.json().catch(() => ({}));
          console.error('削除エラー:', errData);
          alert(`削除失敗 (status: ${res.status})`);
        }
      } catch (err) {
        console.error('通信エラー:', err);
        alert('通信に失敗しました');
      }
    }

    // -------------------------------------------------------
    // 画像モーダル (大きいプレビュー + アップロード更新)
    // -------------------------------------------------------
    const imageModal    = document.getElementById('imageModal');
    const bigPreview    = document.getElementById('bigPreview');
    const noImageText   = document.getElementById('noImageText');
    const replaceForm   = document.getElementById('replace-form');
    const replaceFile   = document.getElementById('replaceImageFile');

    let currentMealId   = '';
    let newImageBase64  = '';

    function openImageModal(mealId, mealImage) {
      currentMealId = mealId;
      newImageBase64 = '';
      replaceImageFile.value = '';

      // 画像がある場合 → src 属性に代入 & 表示
      if (mealImage) {
        bigPreview.src = `http://localhost:9000/${mealImage}`;
        bigPreview.classList.remove('hidden');
        noImageText.classList.add('hidden');
      } else {
        // 画像がない場合 → src を空にし、"画像が登録されていません" を表示
        bigPreview.src = '';
        bigPreview.classList.add('hidden');
        noImageText.classList.remove('hidden');
      }

      imageModal.classList.remove('hidden');
      imageModal.classList.add('flex');
    }
    window.openImageModal = openImageModal;

    function closeImageModal() {
      imageModal.classList.add('hidden');
      imageModal.classList.remove('flex');
    }
    window.closeImageModal = closeImageModal;

    // 画像ファイル選択
    replaceFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) {
        newImageBase64 = '';
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        newImageBase64 = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // [更新] ボタン → PATCH /meals/:id (画像差し替え)
    replaceForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (!currentMealId) return;

      if (!newImageBase64) {
        alert('画像が選択されていません');
        return;
      }

      const payload = { meal_image: newImageBase64 };
      const url = `http://localhost:3000/meals/${currentMealId}`;

      try {
        const res = await fetch(url, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (res.status === 200) {
          alert('画像を更新しました');
          closeImageModal();
          fetchMealsList(); // 再読み込みでセルも更新
        } else {
          const errData = await res.json().catch(() => ({}));
          console.error('画像更新エラー:', errData);
          alert(`画像更新失敗 (status: ${res.status})`);
        }
      } catch (err) {
        console.error('通信エラー:', err);
        alert('通信に失敗しました');
      }
    });

    // -------------------------------------------------------
    // 新規追加モーダル: POST /meals
    // -------------------------------------------------------
    const showModalBtn = document.getElementById('showModalBtn');
    const mealModal    = document.getElementById('mealModal');
    const mealForm     = document.getElementById('meal-form');
    const fileInput    = document.getElementById('meal_image_file');
    const previewImg   = document.getElementById('preview');

    let base64Image    = '';

    // +ボタン → モーダル表示
    showModalBtn.addEventListener('click', () => {
      mealModal.classList.remove('hidden');
      mealModal.classList.add('flex');
    });

    function closeModal() {
      mealModal.classList.add('hidden');
      mealModal.classList.remove('flex');
    }
    window.closeModal = closeModal;

    // ファイル選択 → プレビュー
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) {
        base64Image = '';
        previewImg.classList.add('hidden');
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        base64Image = ev.target.result;
        previewImg.src = base64Image;
        previewImg.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });

    // フォーム送信 → POST
    mealForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();

      const nameField = document.getElementById('name');
      const descField = document.getElementById('description');
      const kindField = document.getElementById('kind');

      const name = nameField.value.trim();
      const description = descField.value.trim();
      const kind = kindField.value;

      const payload = { name, kind };
      if (description) {
        payload.description = description;
      }
      if (base64Image) {
        payload.meal_image = base64Image;
      }

      try {
        const res = await fetch('http://localhost:3000/meals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (res.status === 201) {
          alert('食事の登録が完了しました');
          closeModal();
          mealForm.reset();
          previewImg.classList.add('hidden');
          base64Image = '';
          fetchMealsList();
        } else {
          const errorData = await res.json().catch(() => ({}));
          console.error('登録エラー:', errorData);
          alert(`登録に失敗しました (status: ${res.status})`);
        }
      } catch (err) {
        console.error('通信エラー:', err);
        alert(`通信に失敗しました: ${err.message}`);
      }
    });
  </script>
</body>
</html>
